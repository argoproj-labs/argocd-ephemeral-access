apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller
  namespace: argocd-ephemeral-access
spec:
  template:
    spec:
      initContainers:
        - name: plugin-installer
          image: argocd-ephemeral-access-installer:latest
          env:
            - name: PLUGIN_PATH
              value: /workspace/plugin
          volumeMounts:
            - name: plugins
              mountPath: /tmp/plugin/
          securityContext:
            runAsUser: 65534
            allowPrivilegeEscalation: false
      containers:
        - name: controller
          env:
            - name: EPHEMERAL_PLUGIN_PATH
              value: /tmp/plugin/plugin
          volumeMounts:
            - name: plugins
              mountPath: /tmp/plugin/
      volumes:
        - emptyDir: {}
          name: plugin
